<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Animal Habitat interactive map</title>
    <meta name="description" content="test">
    <meta name="author" content="slawomir.biernacki">

    <link rel="stylesheet" href="css/styles.css?v=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
</head>

<body>

    <style>
        #mapid {
            height: 800px;
        }

        svg {
            position: relative;
        }

        path {
            fill-opacity: .7;
            stroke: rgb(90, 89, 89);
            stroke-width: 1.5px;
        }

        .red {
            fill: rgb(255, 82, 14);
        }

        .green {
            fill: rgb(16, 236, 64);
        }

        /* path:hover {
            fill: brown;
            fill-opacity: .7;
        } */
    </style>

    <div class="container">
        <button type="button" class="btn btn-primary" id="btn1">Happy Monkeys</button>
        <button type=" button" class="btn btn-primary" id="btn2">Sad monkeys</button>
    </div>

    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>

    <script src="//d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://unpkg.com/flubber@0.3.0"></script>
    <script>
        async function main() {
            var map = L.map('mapid').setView([-13.294, -60.624], 4);

            // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

            L.tileLayer('https://api.mapbox.com/styles/v1/xianoss/ck13rc6tx0ceq1cpufzyo2whl/tiles/256/{z}/{x}/{y}@2x?access_token={access_token}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                access_token: 'pk.eyJ1IjoieGlhbm9zcyIsImEiOiJjazEzcXBybDAwYWdoM21tOWJycmI2MDhkIn0.GC6a12y8atojUzy_EeZStQ'
            }).addTo(map);

            var svg = d3.select(map.getPanes().overlayPane).append("svg");
            var g = svg.append("g").attr("class", "leaflet-zoom-hide");

            const data1 = await d3.json("monkey3.json");
            const data2 = await d3.json("monkey2.json");
            doStuff(data1, data2);

            function doStuff(collection1, collection2) {

                // collection = collection1

                var transform = d3.geoTransform({ point: projectPoint })
                var geoGenerator = d3.geoPath().projection(transform);

                var feature = g.selectAll("path")
                    .data(collection1.features)
                    .enter().append("path")
                    .attr("fill", "green");


                map.on("zoom", reset);
                reset();

                $("#btn1").click(function () {
                    update(collection1, "green")
                });

                $("#btn2").click(function () {
                    update(collection2, "red")
                });

                function update(data, color) {

                    var sel = g.selectAll("path")
                        .data(data.features)


                    sel.enter()
                        .append("path")

                    // collection = data

                    sel
                        .transition().duration(500)
                        .ease(d3.easeLinear)
                        .style("fill", color)
                        .attr("d", geoGenerator)

                };

                // Reposition the SVG to cover the features.
                function reset() {

                    var bounds1 = geoGenerator.bounds(collection1),
                        topLeft1 = bounds1[0],
                        bottomRight1 = bounds1[1];

                    var bounds2 = geoGenerator.bounds(collection2),
                        topLeft2 = bounds2[0],
                        bottomRight2 = bounds2[1];

                    var strokeThickness = 3
                    var bottomRight = [Math.max(bottomRight1[0], bottomRight2[0]) + strokeThickness, Math.max(bottomRight1[1], bottomRight2[1]) + strokeThickness]
                    var topLeft = [Math.min(topLeft1[0], topLeft2[0]) - strokeThickness, Math.min(topLeft1[1], topLeft2[1]) - strokeThickness]

                    svg.attr("width", bottomRight[0] - topLeft[0])
                        .attr("height", bottomRight[1] - topLeft[1])
                        .style("left", topLeft[0] + "px")
                        .style("top", topLeft[1] + "px");

                    g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

                    feature.attr("d", geoGenerator);
                }

                // Use Leaflet to implement a D3 geometric transformation.
                function projectPoint(x, y) {
                    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                    this.stream.point(point.x, point.y);
                }
            }

        }
        window.onload = main;
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
</body>

</html>